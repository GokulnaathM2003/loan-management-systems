package com.bank.paymentservice.service;

import com.bank.paymentservice.client.LoanServiceClient;
import com.bank.paymentservice.model.ForeclosureRequest;
import com.bank.paymentservice.repository.ForeclosureRequestRepository;
import org.springframework.stereotype.Service;

import java.time.LocalDate;

@Service
public class ForeclosureService {

    private final ForeclosureRequestRepository repo;
    private final LoanServiceClient loanClient;

    public ForeclosureService(ForeclosureRequestRepository repo,
                              LoanServiceClient loanClient) {
        this.repo = repo;
        this.loanClient = loanClient;
    }

    // STEP 1 — User requests foreclosure
    public String requestForeclosure(Long loanId) {
        ForeclosureRequest req = new ForeclosureRequest();
        req.setLoanId(loanId);
        req.setStatus("PENDING");
        req.setRequestDate(LocalDate.now());

        repo.save(req);
        return "Foreclosure request submitted";
    }

    // STEP 2 — Admin approves and system calculates amount
    public Double approveRequest(Long requestId) {
        ForeclosureRequest req = repo.findById(requestId)
                .orElseThrow(() -> new RuntimeException("Request not found"));

        if (!"PENDING".equals(req.getStatus())) {
            throw new RuntimeException("Already processed");
        }

        Double remaining = loanClient.getRemainingBalance(req.getLoanId());

        req.setStatus("APPROVED");
        req.setApprovedAmount(remaining);
        repo.save(req);

        return remaining;
    }

    // STEP 3 — User pays foreclosure amount
    public String payForeclosure(Long requestId) {
        ForeclosureRequest req = repo.findById(requestId)
                .orElseThrow(() -> new RuntimeException("Request not found"));

        if (!"APPROVED".equals(req.getStatus())) {
            throw new RuntimeException("Not approved yet");
        }

        // Tell loan service to close loan
        loanClient.closeLoan(req.getLoanId());

        req.setStatus("PAID");
        repo.save(req);

        return "Loan foreclosed successfully";
    }
}
