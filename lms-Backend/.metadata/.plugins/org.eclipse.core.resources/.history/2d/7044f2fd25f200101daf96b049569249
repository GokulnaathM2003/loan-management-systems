package com.example.lms_loan_service.service;

import java.time.LocalDate;
import java.util.ArrayList;
import java.util.List;

import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import com.example.lms_loan_service.model.Loan;
import com.example.lms_loan_service.model.RepaymentSchedule;
import com.example.lms_loan_service.model.RepaymentStatus;
import com.example.lms_loan_service.repository.LoanRepository;
import com.example.lms_loan_service.repository.RepaymentScheduleRepository;

@Service
public class RepaymentScheduleService {

    private final RepaymentScheduleRepository repaymentRepo;
    private final LoanRepository loanRepository;

    public RepaymentScheduleService(
            RepaymentScheduleRepository repaymentRepo,
            LoanRepository loanRepository) {
        this.repaymentRepo = repaymentRepo;
        this.loanRepository = loanRepository;
    }

    // üîë GENERATE SCHEDULE (ONE TIME)
    @Transactional
    public void generateSchedule(Long loanId) {

        Loan loan = loanRepository.findById(loanId)
                .orElseThrow(() -> new RuntimeException("Loan not found"));

        // ‚ùó prevent duplicate schedule
        if (repaymentRepo.existsByLoanId(loanId)) {
            throw new RuntimeException("Repayment schedule already exists for this loan");
        }

        List<RepaymentSchedule> schedules = new ArrayList<>();

        LocalDate startDate = loan.getStartDate();
        int tenure = loan.getTenureMonths();
        double emi = loan.getEmiAmount();

        for (int i = 1; i <= tenure; i++) {
            RepaymentSchedule schedule = new RepaymentSchedule();
            schedule.setLoanId(loanId);
            schedule.setInstallmentNo(i);
            schedule.setDueDate(startDate.plusMonths(i));
            schedule.setEmiAmount(emi);
            schedule.setStatus(RepaymentStatus.PENDING);
            schedules.add(schedule);
        }

        repaymentRepo.saveAll(schedules);
    }
}
